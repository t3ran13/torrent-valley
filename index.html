<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="tagsList" style="float: right; width: 200px;"> </div>
<div id="postsList" style="margin-right: 220px;"> </div>
<script src="golos.min.js"></script>
<script>

    function Page() {
        this.posts = {};
        this.tags = {};
    }

    var Page = new Page();

    Page.getApiData = function (query) {
        console.log('getApiData');
        return steem.api.getDiscussionsByCreated(query, function(err, result) {
            console.log(err, result);
            if (err) {
//                this.getApiData(query);
                return;
            }

            result.forEach(function (post) {
                if(typeof(Page.posts.all)== 'undefined') {
                    Page.posts.all = {};
                    Page.posts.all.posts = {};
                }
                Page.posts.all.posts[post.url] = post;
//                console.log(Page.posts);
                if(typeof(Page.posts[post.category]) == 'undefined') {
                    Page.posts[post.category] = {};
                    Page.posts[post.category].posts = {};
                }
                Page.posts[post.category].posts[post.url] = post.url;
//                console.log(Page.posts);
            });

            console.log(Page.posts);
            Page.updatePageContent();
            Page.updateTagsList();

            if (result.length == query.limit) {
                var last = result[query.limit - 1];
                var last = result[query.limit - 1];
                query.start_author = last.author;
                query.start_permlink = last.permlink;
                console.log(query.start_author);
                console.log(query.start_permlink);

//                Page.getApiData(query);
            }
        });
    }

    Page.updatePageContent = function() {
        console.log('updatePageContent');
        var divList = document.getElementById('postsList');
        divList.innerHTML = '';

        console.log(Page.posts.all);
        for (var key in Page.posts.all.posts) {
            var post = Page.posts.all.posts[key];
            var meta = null;
            if (post.json_metadata.length){
                meta = JSON.parse(post.json_metadata);
            }
            var div = document.createElement("div");
            div.style["width"] = '130px';
            div.style["overflow"] = 'hidden';
            div.style["display"] = 'inline-block';

            var p = document.createElement("p");
            var textnode = document.createTextNode(post.title);
            p.style["max-width"] = '100px';
            p.appendChild(textnode);
            div.appendChild(p);

            var img = document.createElement("img");
            var src = '';
            if (meta !== null && typeof(meta.image) !== 'undefined'){
                src = meta.image;
            }
            img.setAttribute("src", src);
            img.setAttribute("height", '100px');
            img.style["max-width"] = '100px';
//            img.style["merge-left"] = 'auto';
            div.appendChild(img);

            divList.appendChild(div);
        }
    }

    Page.updateTagsList = function() {
        console.log('updateTagsList');
        var divList = document.getElementById('tagsList');
        divList.innerHTML = '';

        console.log(Page.posts);
        for (var key in Page.posts) {
            var list = Page.posts[key].posts;
            console.log(list);
            var tagName = (key === 'all' ? key : ('#' + key)) + '(' + Object.keys(list).length + ')';

            var div = document.createElement("div");
//            div.style["width"] = '130px';
            div.style["overflow"] = 'hidden';
//            div.style["display"] = 'inline-block';

            var textnode = document.createTextNode(tagName);
            div.appendChild(textnode);

            divList.appendChild(div);
        }
    }

    Page.init = function() {
        console.log('init');
        var query = {};
        query.select_tags = ['ru--golos'];
        query.limit = 50;

        var result = Page.getApiData(query);
    }

    Page.init();
</script>
</body>
</html>