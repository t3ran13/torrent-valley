<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="tagsList" style="float: right; width: 200px;"> </div>
<div id="postsList" style="margin-right: 220px;"> </div>
<script src="golos.min.js"></script>
<script>

    function Page() {
        this.posts = {};
        this.tags = {};
    }

    var Page = new Page();

    Page.getApiData = function (query, skipFirst) {
        console.log('getApiData');
        return steem.api.getDiscussionsByCreated(query, function(err, result) {
            console.log(err, result);
            if (err) {
//                this.getApiData(query);
                return;
            }

            result.forEach(function (post) {
                if(typeof(Page.posts.all)== 'undefined') {
                    Page.posts.all = {};
                    Page.posts.all.posts = {};
                }
                Page.posts.all.posts[post.id] = post;
//                console.log(Page.posts);
                var meta = JSON.parse(post.json_metadata);
                meta.tags.forEach(function(tag) {
                    if(typeof(Page.posts[tag]) == 'undefined') {
                        Page.posts[tag] = {};
                        Page.posts[tag].posts = {};
                    }
                    Page.posts[tag].posts[post.id] = post.id;
                });
//                console.log(Page.posts);
            });

            console.log(Page.posts);
            Page.updatePageContent(result, skipFirst);
            Page.updateTagsList();
            Page.showVisibleImg();

            if (result.length == query.limit) {
                var last = result[query.limit - 1];
                query.start_author = last.author;
                query.start_permlink = last.permlink;
//                console.log(query.start_author);
//                console.log(query.start_permlink);

                Page.getApiData(query, true);
            }
        });
    }

    Page.updatePageContent = function(added, skipFirst) {
        console.log('updatePageContent');
        var divList = document.getElementById('postsList');
//        divList.innerHTML = '';

        var hash = window.location.hash.substring(1);

        console.log(added);
        for (var key in added) {
            console.log('key', skipFirst);
            if (skipFirst && key === '0') {
                continue;
            }
            var post = added[key];
            var meta = JSON.parse(post.json_metadata);

            var div = document.createElement("div");
            div.setAttribute("id", post.id);
            div.style["width"] = '130px';
            div.style["overflow"] = 'hidden';
            div.style["display"] = meta.tags.indexOf(hash) > -1 || hash === 'all' || hash === '' ? 'inline-block' : 'none';

            var p = document.createElement("p");
            var textnode = document.createTextNode(post.title);
            p.style["max-width"] = '100px';
            p.appendChild(textnode);
            div.appendChild(p);

            var img = document.createElement("img");
            var src = '';
            if (meta !== null && typeof(meta.image) !== 'undefined'){
                src = meta.image;
            }
            img.setAttribute("src", 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');
            img.setAttribute("data-src", src);
            img.setAttribute("height", '100px');
            img.style["max-width"] = '100px';
//            img.style["merge-left"] = 'auto';
            div.appendChild(img);

            divList.appendChild(div);
        }
    }

    Page.updateTagsList = function() {
        console.log('updateTagsList');
        var divList = document.getElementById('tagsList');
        divList.innerHTML = '';

        console.log(Page.posts);
        for (var key in Page.posts) {
            var list = Page.posts[key].posts;
//            console.log(list);
            var tagName = (key === 'all' ? key : ('#' + key)) + '(' + Object.keys(list).length + ')';

            var div = document.createElement("div");
//            div.style["width"] = '130px';
            div.style["overflow"] = 'hidden';
//            div.style["display"] = 'inline-block';

            var a = document.createElement("a");
            a.setAttribute("href", '#' + key);
            var textnode = document.createTextNode(tagName);
            a.appendChild(textnode);
            div.appendChild(a);

            divList.appendChild(div);
        }
    }

    Page.showVisibleImg = function() {
        console.log('showVisibleImg');
        var imgs = document.getElementsByTagName('img');
        for (var i = 0; i < imgs.length; i++) {

            var img = imgs[i];

            var realsrc = img.getAttribute('data-src');
            if (!realsrc) continue;

            if (Page.isVisibleImg(img)) {
                img.setAttribute("src", realsrc);
                img.setAttribute('data-src', '');
            }
        }

    }

    Page.isVisibleImg = function(elem) {

        var coords = elem.getBoundingClientRect();

        var windowHeight = document.documentElement.clientHeight;

        var extendedTop = -windowHeight;
        var extendedBottom = 2 * windowHeight;

        // top visible || bottom visible
        var topVisible = coords.top > extendedTop && coords.top < extendedBottom;
        var bottomVisible = coords.bottom < extendedBottom && coords.bottom > extendedTop;

        return topVisible || bottomVisible;
    }

    Page.showPostsByTag = function(tag) {
        console.log('showPostsByTag');
        var currentTagIds = [];
        if(typeof(Page.posts[tag]) !== 'undefined') {
            var list = Page.posts[tag === '' ? 'all' : tag].posts;
            var currentTagIds = Object.keys(list);
        }
        for (var key in Page.posts.all.posts) {
            var div = document.getElementById(key);
            if (currentTagIds.indexOf(key) > -1) {
                div.style["display"] = 'inline-block';
            } else {
                div.style["display"] = 'none';
            }
        }
    }

    Page.init = function() {
        console.log('init');
        var query = {};
        query.select_tags = ['ru--golos'];
        query.limit = 15;

        Page.getApiData(query, false);
    }

    console.log(window.location.hash);

    Page.init();
    window.onscroll = Page.showVisibleImg;
    window.onhashchange = function () {
        console.log('onhashchange');
        var hash = window.location.hash.substring(1);
        Page.showPostsByTag(hash);
        Page.showVisibleImg();
    }
</script>
</body>
</html>